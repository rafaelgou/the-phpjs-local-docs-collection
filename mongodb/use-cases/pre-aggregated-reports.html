<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en">

<head><title>Pre-Aggregated Reports &mdash; MongoDB Manual 2.4.3</title><link rel="shortcut icon" href="http://media.mongodb.org/favicon.ico" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="robots" content="index" />
  <meta name="release" content="2.4.3"/>
  <meta name="DC.Source" content="https://github.com/mongodb/docs/blob/master/source/use-cases/pre-aggregated-reports.txt"/>
      <link rel="canonical" href="http://docs.mongodb.org/manual/use-cases/pre-aggregated-reports" />
  
   <link rel="stylesheet" href="../_static/mongodb-docs.css" type="text/css" />
   <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      
   <script type="text/javascript">
     var DOCUMENTATION_OPTIONS = {
         URL_ROOT:    '../',
         VERSION:     '2.4',
         COLLAPSE_INDEX: false,
         FILE_SUFFIX: '.html',
         HAS_SOURCE:  false,
     };
   </script>
       <script type="text/javascript" src="../_static/jquery.js"></script>
       <script type="text/javascript" src="../_static/underscore.js"></script>
       <script type="text/javascript" src="../_static/doctools.js"></script>
          <link rel="search" type="application/opensearchdescription+xml" href="http://docs.mongodb.org/osd.xml" title="MongoDB Help"/>
<link rel="author" title="About these documents" href="../about.html" />
<link rel="top" title="MongoDB Manual" href="../index.html" />
<link rel="up" title="Use Cases" href="../use-cases.html" />
<link rel="next" title="Hierarchical Aggregation" href="hierarchical-aggregation.html" />
<link rel="prev" title="Storing Log Data" href="storing-log-data.html" />
          <script>
            (function() {
               var cx = '017213726194841070573:WMX6838984';
               var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
               gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.google.com/cse/cse.js?cx=' + cx;
               var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
            })();
          </script></head>
<body>
      <div id="header-db" class="spread">
        <div class="split">
          <div id="logo">
            <div><a href="http://www.mongodb.org/"><img class="logo" src="http://media.mongodb.org/logo-mongodb.png" alt="MongoDB Logo"/></a></div>
          </div>
        </div>
      </div>  
      <div class="document">
           <div class="documentwrapper"><div class="bodywrapper">
               <div class="body">
                 
    <div class="bc">
      <ul>
          <li><a href="../use-cases.html">Use Cases</a><span class="bcpoint"> > </span></li>
          <li>Pre-Aggregated Reports</li> 
      </ul>
    </div>
                 <div id="cse-results">
                   <gcse:searchresults linkTarget="_top"></gcse:searchresults>
                 </div>
                 
  <div class="section" id="pre-aggregated-reports">
<h1>Pre-Aggregated Reports<a class="headerlink" href="#pre-aggregated-reports" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This document outlines the basic patterns and principles for using
MongoDB as an engine for collecting and processing events in real time
for use in generating up to the minute or second reports.</p>
<div class="section" id="problem">
<h3>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h3>
<p>Servers and other systems can generate a large number of documents,
and it can be difficult to access and analyze such large collections
of data originating from multiple servers.</p>
<p>This document makes the following assumptions about real-time
analytics:</p>
<ul class="simple">
<li>There is no need to retain transactional event data in MongoDB, and
how your application handles transactions is outside of the scope of
this document.</li>
<li>You require up-to-the minute data, or up-to-the-second if possible.</li>
<li>The queries for ranges of data (by time) must be as fast as
possible.</li>
</ul>
<div class="admonition-see-also admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">&#8220;<a class="reference internal" href="storing-log-data.html"><em>Storing Log Data</em></a>.&#8221;</p>
</div>
</div>
<div class="section" id="solution">
<h3>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">¶</a></h3>
<p>The solution described below assumes a simple scenario using data from
web server access logs. With this data, you will want to return the
number of hits to a collection of web sites at various levels of
granularity based on time (i.e. by minute, hour, day, week, and month)
as well as by the path of a resource.</p>
<p>To achieve the required performance to support these tasks,
<a class="reference internal" href="../reference/glossary.html#term-upsert"><em class="xref std std-term">upserts</em></a> and <a class="reference internal" href="../reference/operator/inc.html#op._S_inc" title="$inc"><tt class="xref mongodb mongodb-operator docutils literal"><span class="pre">increment</span></tt></a> operations
will allow you to calculate statistics, produce simple range-based
queries, and generate filters to support time-series charts of
aggregated data.</p>
</div>
</div>
<div class="section" id="schema">
<h2>Schema<a class="headerlink" href="#schema" title="Permalink to this headline">¶</a></h2>
<p>Schemas for real-time analytics systems must support simple and fast
query and update operations. In particular, attempt to avoid the
following situations which can degrade performance:</p>
<ul>
<li><p class="first"><a class="reference internal" href="../reference/glossary.html#term-document"><em class="xref std std-term">documents</em></a> growing significantly after creation.</p>
<p>Document growth forces MongoDB to move the document on disk, which
can be time and resource consuming relative to other operations;</p>
</li>
<li><p class="first">queries requiring MongoDB to scan documents in the collection without
using indexes; and</p>
</li>
<li><p class="first">deeply nested documents that make accessing particular fields slow.</p>
</li>
</ul>
<p>Intuitively, you may consider keeping &#8220;hit counts&#8221; in individual
documents with one document for every unit of time (i.e. minute, hour,
day, etc.) However, queries must return multiple documents for all
non-trivial time-rage queries, which can slow overall query
performance.</p>
<p>Preferably, to maximize query performance, use more complex documents,
and keep several aggregate values in each document. The remainder of
this section outlines several schema designs that you may consider for
this real-time analytics system. While there is no single pattern for
every problem, each pattern is more well suited to specific classes of
problems.</p>
<div class="section" id="one-document-per-page-per-day">
<span id="rta-schema-one-document-per-page-per-day"></span><h3>One Document Per Page Per Day<a class="headerlink" href="#one-document-per-page-per-day" title="Permalink to this headline">¶</a></h3>
<p>Consider the following example schema for a solution that stores all
statistics for a single day and page in a single <a class="reference internal" href="../reference/glossary.html#term-document"><em class="xref std std-term">document</em></a>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;20101010/site-1/apache_pb.gif&quot;</span><span class="p">,</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">date</span><span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2000-10-10T00:00:00Z&quot;</span><span class="p">),</span>
        <span class="nx">site</span><span class="o">:</span> <span class="s2">&quot;site-1&quot;</span><span class="p">,</span>
        <span class="nx">page</span><span class="o">:</span> <span class="s2">&quot;/apache_pb.gif&quot;</span> <span class="p">},</span>
    <span class="nx">daily</span><span class="o">:</span> <span class="mi">5468426</span><span class="p">,</span>
    <span class="nx">hourly</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="mi">227850</span><span class="p">,</span>
        <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="mi">210231</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="s2">&quot;23&quot;</span><span class="o">:</span> <span class="mi">20457</span> <span class="p">},</span>
    <span class="nx">minute</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="mi">3612</span><span class="p">,</span>
        <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="mi">3241</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="s2">&quot;1439&quot;</span><span class="o">:</span> <span class="mi">2819</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This approach has a couple of advantages:</p>
<ul class="simple">
<li>For every request on the website, you only need to update one
document.</li>
<li>Reports for time periods within the day, for a single page
require fetching a single document.</li>
</ul>
<p>There are, however, significant issues with this approach. The most
significant issue is that, as you <a class="reference internal" href="../reference/glossary.html#term-upsert"><em class="xref std std-term">upsert</em></a> data into the
<tt class="docutils literal"><span class="pre">hourly</span></tt> and <tt class="docutils literal"><span class="pre">monthly</span></tt> fields, the document grows. Although
MongoDB will pad the space allocated to documents, it must still will
need to reallocate these documents multiple times throughout the day,
which impacts performance.</p>
</div>
<div class="section" id="pre-allocate-documents">
<span id="rta-pre-aggregate-documents"></span><h3>Pre-allocate Documents<a class="headerlink" href="#pre-allocate-documents" title="Permalink to this headline">¶</a></h3>
<div class="section" id="simple-pre-allocation">
<h4>Simple Pre-Allocation<a class="headerlink" href="#simple-pre-allocation" title="Permalink to this headline">¶</a></h4>
<p>To mitigate the impact of repeated document migrations throughout the
day, you can tweak the &#8220;<a class="reference internal" href="#rta-schema-one-document-per-page-per-day"><em>one document per page per day</em></a>&#8221; approach by adding a
process that &#8220;pre-allocates&#8221; documents with fields that hold <tt class="docutils literal"><span class="pre">0</span></tt>
values throughout the previous day. Thus, at midnight, new documents
will exist.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>To avoid situations where your application must pre-allocate large
numbers of documents at midnight, it&#8217;s best to create documents
throughout the previous day by <a class="reference internal" href="../reference/glossary.html#term-upsert"><em class="xref std std-term">upserting</em></a> randomly
when you update a value in the current day&#8217;s data.</p>
<p>This requires some tuning, to balance two requirements:</p>
<ol class="arabic simple">
<li>your application should have pre-allocated all or nearly all of
documents by the end of the day.</li>
<li>your application should infrequently pre-allocate a document
that already exists to save time and resources on extraneous
upserts.</li>
</ol>
<p class="last">As a starting point, consider the average number of hits a day
(<tt class="docutils literal"><span class="pre">h</span></tt>), and then upsert a blank document upon update with a
probability of <tt class="docutils literal"><span class="pre">1/h</span></tt>.</p>
</div>
<p>Pre-allocating increases performance by initializing all documents
with <tt class="docutils literal"><span class="pre">0</span></tt> values in all fields. After create, documents will never
grow. This means that:</p>
<ol class="arabic simple">
<li>there will be no need to migrate documents within the data store,
which is a problem in the &#8220;<a class="reference internal" href="#rta-schema-one-document-per-page-per-day"><em>one document per page per day</em></a>&#8221; approach.</li>
<li>MongoDB will not add padding to the records, which leads to a more
compact data representation and better memory use of your memory.</li>
</ol>
</div>
<div class="section" id="add-intra-document-hierarchy">
<h4>Add Intra-Document Hierarchy<a class="headerlink" href="#add-intra-document-hierarchy" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">MongoDB stores <a class="reference internal" href="../reference/glossary.html#term-bson"><em class="xref std std-term">BSON</em></a> <a class="reference internal" href="../reference/glossary.html#term-document"><em class="xref std std-term">documents</em></a> as a
sequence of fields and values, <em>not</em> as a hash table. As a result,
writing to the field <tt class="docutils literal"><span class="pre">stats.mn.0</span></tt> is considerably faster than
writing to <tt class="docutils literal"><span class="pre">stats.mn.1439</span></tt>.</p>
</div>
<div class="figure align-center">
<img alt="BSON memory layout (unoptimized)" src="../_images/preagg1.png" />
<p class="caption">In order to update the value in minute #1349, MongoDB must skip over all 1349
entries before it.</p>
</div>
<p>To optimize update and insert operations you can introduce
intra-document hierarchy. In particular, you can split the <tt class="docutils literal"><span class="pre">minute</span></tt>
field up into 24 hourly fields:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;20101010/site-1/apache_pb.gif&quot;</span><span class="p">,</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">date</span><span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2000-10-10T00:00:00Z&quot;</span><span class="p">),</span>
        <span class="nx">site</span><span class="o">:</span> <span class="s2">&quot;site-1&quot;</span><span class="p">,</span>
        <span class="nx">page</span><span class="o">:</span> <span class="s2">&quot;/apache_pb.gif&quot;</span> <span class="p">},</span>
    <span class="nx">daily</span><span class="o">:</span> <span class="mi">5468426</span><span class="p">,</span>
    <span class="nx">hourly</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="mi">227850</span><span class="p">,</span>
        <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="mi">210231</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="s2">&quot;23&quot;</span><span class="o">:</span> <span class="mi">20457</span> <span class="p">},</span>
    <span class="nx">minute</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="mi">3612</span><span class="p">,</span>
            <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="mi">3241</span><span class="p">,</span>
            <span class="p">...</span>
            <span class="s2">&quot;59&quot;</span><span class="o">:</span> <span class="mi">2130</span> <span class="p">},</span>
        <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;60&quot;</span><span class="o">:</span> <span class="p">...</span> <span class="p">,</span>
        <span class="p">},</span>
        <span class="p">...</span>
        <span class="s2">&quot;23&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="s2">&quot;1439&quot;</span><span class="o">:</span> <span class="mi">2819</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This allows MongoDB to &#8220;skip forward&#8221; throughout the day when updating
the minute data, which makes the update performance more uniform and
faster later in the day.</p>
<div class="figure align-center">
<img alt="BSON memory layout (optimized)" src="../_images/preagg2.png" />
<p class="caption">To update the value in minute #1349, MongoDB first skips the first
23 hours and then skips 59 minutes for only 82 skips as opposed to
1439 skips in the previous schema.</p>
</div>
</div>
</div>
<div class="section" id="separate-documents-by-granularity-level">
<h3>Separate Documents by Granularity Level<a class="headerlink" href="#separate-documents-by-granularity-level" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#rta-pre-aggregate-documents"><em>Pre-allocating documents</em></a> is a
reasonable design for storing intra-day data, but the model breaks
down when displaying data over longer multi-day periods like months or
quarters. In these cases, consider storing daily statistics in a
single document as above, and then aggregate monthly data into a
separate document.</p>
<p>This introduce a second set of <a class="reference internal" href="../reference/glossary.html#term-upsert"><em class="xref std std-term">upsert</em></a> operations to the data
collection and aggregation portion of your application but the gains
reduction in disk seeks on the queries, should be worth the
costs. Consider the following example schema:</p>
<ol class="arabic">
<li><p class="first">Daily Statistics</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;20101010/site-1/apache_pb.gif&quot;</span><span class="p">,</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">date</span><span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2000-10-10T00:00:00Z&quot;</span><span class="p">),</span>
        <span class="nx">site</span><span class="o">:</span> <span class="s2">&quot;site-1&quot;</span><span class="p">,</span>
        <span class="nx">page</span><span class="o">:</span> <span class="s2">&quot;/apache_pb.gif&quot;</span> <span class="p">},</span>
    <span class="nx">hourly</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="mi">227850</span><span class="p">,</span>
        <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="mi">210231</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="s2">&quot;23&quot;</span><span class="o">:</span> <span class="mi">20457</span> <span class="p">},</span>
    <span class="nx">minute</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="mi">3612</span><span class="p">,</span>
            <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="mi">3241</span><span class="p">,</span>
            <span class="p">...</span>
            <span class="s2">&quot;59&quot;</span><span class="o">:</span> <span class="mi">2130</span> <span class="p">},</span>
        <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;0&quot;</span><span class="o">:</span> <span class="p">...,</span>
        <span class="p">},</span>
        <span class="p">...</span>
        <span class="s2">&quot;23&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;59&quot;</span><span class="o">:</span> <span class="mi">2819</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Monthly Statistics</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="s2">&quot;201010/site-1/apache_pb.gif&quot;</span><span class="p">,</span>
    <span class="nx">metadata</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">date</span><span class="o">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="s2">&quot;2000-10-00T00:00:00Z&quot;</span><span class="p">),</span>
        <span class="nx">site</span><span class="o">:</span> <span class="s2">&quot;site-1&quot;</span><span class="p">,</span>
        <span class="nx">page</span><span class="o">:</span> <span class="s2">&quot;/apache_pb.gif&quot;</span> <span class="p">},</span>
    <span class="nx">daily</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;1&quot;</span><span class="o">:</span> <span class="mi">5445326</span><span class="p">,</span>
        <span class="s2">&quot;2&quot;</span><span class="o">:</span> <span class="mi">5214121</span><span class="p">,</span>
        <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="operations">
<h2>Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h2>
<p>This section outlines a number of common operations for building and
interacting with real-time-analytics reporting system. The major
challenge is in balancing performance and write (i.e. <a class="reference internal" href="../reference/glossary.html#term-upsert"><em class="xref std std-term">upsert</em></a>)
performance. All examples in this document use the Python programming
language and the <a class="reference external" href="http://api.mongodb.org/python/current">PyMongo</a> <a class="reference internal" href="../reference/glossary.html#term-driver"><em class="xref std std-term">driver</em></a> for
MongoDB, but you can implement this system using any language you
choose.</p>
<div class="section" id="log-an-event">
<h3>Log an Event<a class="headerlink" href="#log-an-event" title="Permalink to this headline">¶</a></h3>
<p>Logging an event such as a page request (i.e. &#8220;hit&#8221;) is the main
&#8220;write&#8221; activity for your system. To maximize performance, you&#8217;ll be
doing in-place updates with the <a class="reference internal" href="../reference/glossary.html#term-upsert"><em class="xref std std-term">upsert</em></a> operation. Consider the
following example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>

<span class="k">def</span> <span class="nf">log_hit</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">dt_utc</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>

    <span class="c"># Update daily stats doc</span>
    <span class="n">id_daily</span> <span class="o">=</span> <span class="n">dt_utc</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="n">page</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">dt_utc</span><span class="o">.</span><span class="n">hour</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">dt_utc</span><span class="o">.</span><span class="n">minute</span>

    <span class="c"># Get a datetime that only includes date info</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">dt_utc</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="n">id_daily</span><span class="p">,</span>
        <span class="s">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="n">site</span><span class="p">,</span> <span class="s">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">update</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;$inc&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;hourly.</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hour</span><span class="p">,):</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">&#39;minute.</span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hour</span><span class="p">,</span><span class="n">minute</span><span class="p">):</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># Update monthly stats document</span>
    <span class="n">id_monthly</span> <span class="o">=</span> <span class="n">dt_utc</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="n">page</span>
    <span class="n">day_of_month</span> <span class="o">=</span> <span class="n">dt_utc</span><span class="o">.</span><span class="n">day</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="n">id_monthly</span><span class="p">,</span>
        <span class="s">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="n">site</span><span class="p">,</span>
            <span class="s">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">update</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;$inc&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;daily.</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">day_of_month</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">monthly</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">upsert</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The upsert operation (i.e. <tt class="docutils literal"><span class="pre">upsert=True</span></tt>) performs an update if the
document exists, and an insert if the document does not exist.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This application requires upserts, because the <a class="reference internal" href="#rta-pre-allocate-operation"><em>pre-allocation</em></a> method only pre-allocates new
documents with a high probability, not with complete certainty.</p>
<p class="last">Without preallocation, you end up with a dynamically growing
document, slowing upserts as MongoDB moves documents to accommodate
growth.</p>
</div>
</div>
<div class="section" id="pre-allocate">
<span id="rta-pre-allocate-operation"></span><h3>Pre-allocate<a class="headerlink" href="#pre-allocate" title="Permalink to this headline">¶</a></h3>
<p>To prevent document growth, you can preallocate new documents before
the system needs them. As you create new documents, set all values to
<tt class="docutils literal"><span class="pre">0</span></tt> for so that documents will not grow to accommodate
updates. Consider the following <tt class="xref py py-func docutils literal"><span class="pre">preallocate()</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">preallocate</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">dt_utc</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>

    <span class="c"># Get id values</span>
    <span class="n">id_daily</span> <span class="o">=</span> <span class="n">dt_utc</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="n">page</span>
    <span class="n">id_monthly</span> <span class="o">=</span> <span class="n">dt_utc</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">site</span> <span class="o">+</span> <span class="n">page</span>

    <span class="c"># Get daily metadata</span>
    <span class="n">daily_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">dt_utc</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">),</span>
        <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="n">site</span><span class="p">,</span>
        <span class="s">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span> <span class="p">}</span>
    <span class="c"># Get monthly metadata</span>
    <span class="n">monthly_metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">daily_metadata</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="n">site</span><span class="p">,</span>
        <span class="s">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span> <span class="p">}</span>

    <span class="c"># Initial zeros for statistics</span>
    <span class="n">hourly</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
    <span class="n">daily</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>

    <span class="c"># Perform upserts, setting metadata</span>
    <span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="n">id_daily</span><span class="p">,</span>
            <span class="s">&#39;hourly&#39;</span><span class="p">:</span> <span class="n">hourly</span><span class="p">,</span>
            <span class="s">&#39;minute&#39;</span><span class="p">:</span> <span class="n">minute</span><span class="p">},</span>
        <span class="p">{</span> <span class="s">&#39;$set&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">daily_metadata</span> <span class="p">}},</span>
        <span class="n">upsert</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">monthly</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="n">id_monthly</span><span class="p">,</span>
            <span class="s">&#39;daily&#39;</span><span class="p">:</span> <span class="n">daily</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&#39;$set&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="n">monthly_metadata</span> <span class="p">}},</span>
        <span class="n">upsert</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The function pre-allocated both the monthly <em>and</em> daily documents at
the same time. The performance benefits from separating these
operations are negligible, so it&#8217;s reasonable to keep both operations
in the same function.</p>
<p>Ideally, your application should pre-allocate documents <em>before</em>
needing to write data to maintain consistent update
performance. Additionally, its important to avoid causing a spike in
activity and latency by creating documents all at once.</p>
<p>In the following example, document updates (i.e. &#8220;<tt class="xref py py-func docutils literal"><span class="pre">log_hit()</span></tt>&#8221;) will
also pre-allocate a document probabilistically. However, by &#8220;tuning
probability,&#8221; you can limit redundant <tt class="xref py py-func docutils literal"><span class="pre">preallocate()</span></tt> calls.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">time</span>

<span class="c"># Example probability based on 500k hits per day per page</span>
<span class="n">prob_preallocate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">500000</span>

<span class="k">def</span> <span class="nf">log_hit</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">dt_utc</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">page</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">prob_preallocate</span><span class="p">:</span>
        <span class="n">preallocate</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">dt_utc</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">site</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
    <span class="c"># Update daily stats doc</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Using this method, there will be a high probability that each document
will already exist before your application needs to issue update
operations. You&#8217;ll also be able to prevent a regular spike in activity
for pre-allocation, and be able to eliminate document growth.</p>
</div>
<div class="section" id="retrieving-data-for-a-real-time-chart">
<h3>Retrieving Data for a Real-Time Chart<a class="headerlink" href="#retrieving-data-for-a-real-time-chart" title="Permalink to this headline">¶</a></h3>
<p>This example describes fetching the data from the above MongoDB
system, for use in generating a chart that displays the number of hits
to a particular resource over the last hour.</p>
<div class="section" id="querying">
<h4>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¶</a></h4>
<p>Use the following query in a <a class="reference external" href="http://api.mongodb.org/python/current/api/pymongo/collection.html#pymongo.collection.Collection.find_one" title="(in PyMongo v2.5.1)"><tt class="xref py py-meth docutils literal"><span class="pre">find_one</span></tt></a> operation at the
Python/PyMongo console to retrieve the number of hits to a specific
resource (i.e. <tt class="docutils literal"><span class="pre">/index.html</span></tt>) with minute-level granularity:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;date&#39;</span><span class="p">:</span><span class="n">dt</span><span class="p">,</span> <span class="s">&#39;site&#39;</span><span class="p">:</span><span class="s">&#39;site-1&#39;</span><span class="p">,</span> <span class="s">&#39;page&#39;</span><span class="p">:</span><span class="s">&#39;/index.html&#39;</span><span class="p">}},</span>
<span class="gp">... </span>    <span class="p">{</span> <span class="s">&#39;minute&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</pre></div>
</div>
<p>Use the following query to retrieve the number of hits to a resource
over the last day, with hour-level granularity:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;date&#39;</span><span class="p">:</span><span class="n">dt</span><span class="p">,</span> <span class="s">&#39;site&#39;</span><span class="p">:</span><span class="s">&#39;site-1&#39;</span><span class="p">,</span> <span class="s">&#39;page&#39;</span><span class="p">:</span><span class="s">&#39;/foo.gif&#39;</span><span class="p">}},</span>
<span class="gp">... </span>    <span class="p">{</span> <span class="s">&#39;hourly&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</pre></div>
</div>
<p>If you want a few days of hourly data, you can use a query in the
following form:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span>
<span class="gp">... </span>        <span class="s">&#39;metadata.date&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;$gte&#39;</span><span class="p">:</span> <span class="n">dt1</span><span class="p">,</span> <span class="s">&#39;$lte&#39;</span><span class="p">:</span> <span class="n">dt2</span> <span class="p">},</span>
<span class="gp">... </span>        <span class="s">&#39;metadata.site&#39;</span><span class="p">:</span> <span class="s">&#39;site-1&#39;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&#39;metadata.page&#39;</span><span class="p">:</span> <span class="s">&#39;/index.html&#39;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">{</span> <span class="s">&#39;metadata.date&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;hourly&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="gp">... </span>    <span class="n">sort</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;metadata.date&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="indexing">
<h4>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h4>
<p>To support these query operation, create a compound index on the
following daily statistics fields: <tt class="docutils literal"><span class="pre">metadata.site</span></tt>,
<tt class="docutils literal"><span class="pre">metadata.page</span></tt>, and <tt class="docutils literal"><span class="pre">metadata.date</span></tt> (in that order.) Use the
following operation at the Python/PyMongo console.</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">daily</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">([</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s">&#39;metadata.site&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s">&#39;metadata.page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s">&#39;metadata.date&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
<p>This index makes it possible to efficiently run the query for multiple
days of hourly data. At the same time, any compound index on page and
date, will allow you to query efficiently for a single day&#8217;s
statistics.</p>
</div>
</div>
<div class="section" id="get-data-for-a-historical-chart">
<h3>Get Data for a Historical Chart<a class="headerlink" href="#get-data-for-a-historical-chart" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>Querying<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>To retrieve daily data for a single month, use the following query:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">monthly</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span><span class="s">&#39;metadata&#39;</span><span class="p">:</span>
<span class="gp">... </span>        <span class="p">{</span><span class="s">&#39;date&#39;</span><span class="p">:</span><span class="n">dt</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&#39;site&#39;</span><span class="p">:</span> <span class="s">&#39;site-1&#39;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&#39;page&#39;</span><span class="p">:</span><span class="s">&#39;/index.html&#39;</span><span class="p">}},</span>
<span class="gp">... </span>    <span class="p">{</span> <span class="s">&#39;daily&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</pre></div>
</div>
<p>To retrieve several months of daily data, use a variation on the above
query:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">monthly</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">{</span>
<span class="gp">... </span>        <span class="s">&#39;metadata.date&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s">&#39;$gte&#39;</span><span class="p">:</span> <span class="n">dt1</span><span class="p">,</span> <span class="s">&#39;$lte&#39;</span><span class="p">:</span> <span class="n">dt2</span> <span class="p">},</span>
<span class="gp">... </span>        <span class="s">&#39;metadata.site&#39;</span><span class="p">:</span> <span class="s">&#39;site-1&#39;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s">&#39;metadata.page&#39;</span><span class="p">:</span> <span class="s">&#39;/index.html&#39;</span><span class="p">},</span>
<span class="gp">... </span>    <span class="p">{</span> <span class="s">&#39;metadata.date&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;daily&#39;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">},</span>
<span class="gp">... </span>    <span class="n">sort</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;metadata.date&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>Indexing<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Create the following index to support these queries for monthly data
on the <tt class="docutils literal"><span class="pre">metadata.site</span></tt>, <tt class="docutils literal"><span class="pre">metadata.page</span></tt>, and
<tt class="docutils literal"><span class="pre">metadata.date</span></tt> fields:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">monthly</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">([</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s">&#39;metadata.site&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s">&#39;metadata.page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s">&#39;metadata.date&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
<p>This field order will efficiently support range queries for a single
page over several months.</p>
</div>
</div>
</div>
<div class="section" id="sharding">
<h2>Sharding<a class="headerlink" href="#sharding" title="Permalink to this headline">¶</a></h2>
<p>The only potential limits on the performance of this system are the
number of <a class="reference internal" href="../reference/glossary.html#term-shard"><em class="xref std std-term">shards</em></a> in your <a class="reference internal" href="../reference/glossary.html#term-sharded-cluster"><em class="xref std std-term">system</em></a>, and the <a class="reference internal" href="../reference/glossary.html#term-shard-key"><em class="xref std std-term">shard key</em></a> that you use.</p>
<blockquote class="pull-quote">
<div>An ideal shard key will distribute <a class="reference internal" href="../reference/glossary.html#term-upsert"><em class="xref std std-term">upserts</em></a> between
the shards while routing all queries to a single shard, or a small
number of shards.</div></blockquote>
<p>While your choice of shard key may depend on the precise workload of
your deployment, consider using <tt class="docutils literal"><span class="pre">{</span> <span class="pre">metadata.site:</span> <span class="pre">1,</span> <span class="pre">metadata.page:</span>
<span class="pre">1</span> <span class="pre">}</span></tt> as a <a class="reference internal" href="../reference/glossary.html#term-shard-key"><em class="xref std std-term">shard key</em></a>. The combination of site and page (or
event) will lead to a well balanced cluster for most deployments.</p>
<p>Enable sharding for the daily statistics collection with the following
<a class="reference internal" href="../reference/command/shardCollection.html#dbcmd.shardCollection" title="shardCollection"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">shardCollection</span></tt></a> command in the Python/PyMongo console:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;shardCollection&#39;</span><span class="p">,</span> <span class="s">&#39;stats.daily&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="n">key</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;metadata.site&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;metadata.page&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">})</span>
</pre></div>
</div>
<p>Upon success, you will see the following response:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="s2">&quot;collectionsharded&quot;</span> <span class="o">:</span> <span class="s2">&quot;stats.daily&quot;</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</pre></div>
</div>
<p>Enable sharding for the monthly statistics collection with the
following <a class="reference internal" href="../reference/command/shardCollection.html#dbcmd.shardCollection" title="shardCollection"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">shardCollection</span></tt></a> command in the Python/PyMongo
console:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;shardCollection&#39;</span><span class="p">,</span> <span class="s">&#39;stats.monthly&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="n">key</span> <span class="p">:</span> <span class="p">{</span> <span class="s">&#39;metadata.site&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;metadata.page&#39;</span> <span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">})</span>
</pre></div>
</div>
<p>Upon success, you will see the following response:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="s2">&quot;collectionsharded&quot;</span> <span class="o">:</span> <span class="s2">&quot;stats.monthly&quot;</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</pre></div>
</div>
<p>One downside of the <tt class="docutils literal"><span class="pre">{</span> <span class="pre">metadata.site:</span> <span class="pre">1,</span> <span class="pre">metadata.page:</span> <span class="pre">1</span> <span class="pre">}</span></tt>
<a class="reference internal" href="../reference/glossary.html#term-shard-key"><em class="xref std std-term">shard key</em></a> is: if one page dominates all your traffic, all
updates to that page will go to a single shard. This is basically
unavoidable, since all update for a single page are going to a single
<em>document</em>.</p>
<p>You may wish to include the date in addition to the site, and page
fields so that MongoDB can split histories so that you can serve
different historical ranges with different shards. Use the following
<a class="reference internal" href="../reference/command/shardCollection.html#dbcmd.shardCollection" title="shardCollection"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">shardCollection</span></tt></a> command to shard the daily statistics
collection in the Python/PyMongo console:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;shardCollection&#39;</span><span class="p">,</span> <span class="s">&#39;stats.daily&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s">&#39;key&#39;</span><span class="p">:{</span><span class="s">&#39;metadata.site&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;metadata.page&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;metadata.date&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
<span class="go">{ &quot;collectionsharded&quot; : &quot;stats.daily&quot;, &quot;ok&quot; : 1 }</span>
</pre></div>
</div>
<p>Enable sharding for the monthly statistics collection with the
following <a class="reference internal" href="../reference/command/shardCollection.html#dbcmd.shardCollection" title="shardCollection"><tt class="xref mongodb mongodb-dbcommand docutils literal"><span class="pre">shardCollection</span></tt></a> command in the Python/PyMongo
console:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">db</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;shardCollection&#39;</span><span class="p">,</span> <span class="s">&#39;stats.monthly&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s">&#39;key&#39;</span><span class="p">:{</span><span class="s">&#39;metadata.site&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;metadata.page&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;metadata.date&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
<span class="go">{ &quot;collectionsharded&quot; : &quot;stats.monthly&quot;, &quot;ok&quot; : 1 }</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Determine your actual requirements and load before deciding to
shard. In many situations a single MongoDB instance may be able to
keep track of all events and pages.</p>
</div>
</div>
</div>


    <div id="btnv">
        <ul id="btnvl">
              <li id="btnvpr"><a href="storing-log-data.html" title="Previous Section: Storing Log Data">&lt; &nbsp; Storing Log Data</a></li>
              <li id="btnvup"><a href="../use-cases.html" title="Parent Section: Use Cases" >&#47;&#92;&nbsp; Use Cases</a></li>
              <li id="btnvnx"><a href="hierarchical-aggregation.html" title="Next Section: Hierarchical Aggregation">Hierarchical Aggregation &nbsp;&gt;</a></li>
        </ul>
    </div></div></div>
           </div>
       <div class="sphinxsidebar">
         <div class="sphinxsidebarwrapper">
  <h3>
    <a href="../index.html">MongoDB Manual</a> <span id="vn">2.4</span>
  </h3>



<div class="site-contents"><a href="../contents.html">Contents</a></div>


<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Install MongoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../administration.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crud.html">Core MongoDB Operations (CRUD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-modeling.html">Data Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aggregation.html">Aggregation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../indexes.html">Indexes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../replication.html">Replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sharding.html">Sharding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../applications.html">Application Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mongo.html">The <tt class="docutils literal"><span class="pre">mongo</span></tt> Shell</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../use-cases.html">Use Cases</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="storing-log-data.html">Storing Log Data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Pre-Aggregated Reports</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="hierarchical-aggregation.html">Hierarchical Aggregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="product-catalog.html">Product Catalog</a></li>
<li class="toctree-l2"><a class="reference internal" href="inventory-management.html">Inventory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="category-hierarchy.html">Category Hierarchy</a></li>
<li class="toctree-l2"><a class="reference internal" href="metadata-and-asset-management.html">Metadata and Asset Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="storing-comments.html">Storing Comments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/write-a-tumblelog-application-with-django-mongodb-engine.html">Write a Tumblelog Application with Django MongoDB Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/write-a-tumblelog-application-with-flask-mongoengine.html">Write a Tumblelog Application with Flask and MongoEngine</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About MongoDB Documentation</a></li>
</ul>



<div class="site-index"><a href="../genindex.html">Index</a></div>
<h3>Formats</h3>
<ul class="this-page-menu">
  <li><a href="/manual/single/">MongoDB Manual, Single HTML Page</a></li>
  <li><a href="http://docs.mongodb.org/master/MongoDB-Manual-master.pdf" rel="nofollow">MongoDB Manual, PDF Format</a></li>
  <li><a href="http://docs.mongodb.org/master/MongoDB-Manual-master.epub" rel="nofollow">MongoDB Manual, ePub Format</a></li>
</ul>
<h3><a href="http://www.mongodb.org/about/">About MongoDB</a></h3>
<ul>
  <li><a href="http://www.mongodb.org/about/introduction">Introduction</a></li>
  <li><a href="http://www.mongodb.org/about/community">User Community</a></li>
  <li><a href="http://mongodb.org/about/community/masters">MongoDB Masters</a></li>
  <li><a href="http://planet.mongodb.org">Planet MongoDB</a></li>
</ul>
<h3><a href="http://docs.mongodb.org/ecosystem/">MongoDB Ecosystem</a></h3>
<ul>
 <li><a href="http://docs.mongodb.org/ecosystem/drivers/">Drivers and Client libraries</a>
   <ul>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/c">C</a> (<a href="http://api.mongodb.org/c/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/cpp">C++</a> (<a href="http://api.mongodb.org/cplusplus/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/csharp">C#</a> (<a href="http://api.mongodb.org/csharp/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/erlang">Erlang</a> (<a href="http://api.mongodb.org/erlang">docs</a>)</li>
     <li><a href="http://hackage.haskell.org/package/mongoDB">Haskell</a> (<a href="http://api.mongodb.org/haskell">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/java">Java</a> (<a href="http://api.mongodb.org/java/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/javascript">JavaScript</a> (<a href="http://api.mongodb.org/js/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/perl">Perl</a> (<a href="http://api.mongodb.org/perl/current/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/php">PHP</a> (<a href="http://php.net/mongo/">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/python">Python</a> (<a href="http://api.mongodb.org/python/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/ruby">Ruby</a> (<a href="http://api.mongodb.org/ruby/current">docs</a>)</li>
     <li><a href="http://docs.mongodb.org/ecosystem/drivers/scala">Scala</a> (<a href="http://api.mongodb.org/scala/casbah/current/">docs</a>)</li>
   </ul>
 </li>
 <li><a href="http://docs.mongodb.org/ecosystem/tools/">Tools and Integration</a></li>
 <li><a href="http://docs.mongodb.org/ecosystem/platforms/">Platform Integration</a></li>
</ul><h3>MongoDB Resources</h3>
<ul>
  <li><a href="http://www.mongodb.org/downloads">Downloads</a></li>
  <li><a href="http://www.10gen.com/events">MongoDB Events</a></li>
  <li><a href="http://www.10gen.com/presentations">Slides and Video</a></li>
  <li><a href="http://www.10gen.com/products/mms/">MongoDB Monitoring Service</a> (<a href="http://mms.10gen.com/help/">docs</a>)</li>
</ul>
         </div>
       </div>
        <div class="clearer"></div>
      </div><div id="top-right">
        <div class="user-right">
          <ul id="header-menu-bar" class="ajs-menu-bar">
            <li class="normal"><a target="_blank" href="http://groups.google.com/group/mongodb-user">Forums</a></li>
            <li class="normal"><a target="_blank" href="http://blog.mongodb.org/">Blog</a></li>
            <li class="normal"><a href="http://www.mongodb.org/downloads">Download</a></li>
            <li class="normal"><a href="http://docs.mongodb.org/ecosystem/drivers/">Drivers</a></li>
            <li class="normal"><a href="http://www.10gen.com/events">Events</a></li>
            <li class="normal last"><a class="last" href="http://docs.mongodb.org/manual/meta/translation">Translations</a></li>
          </ul>
        </div>
      </div>
      <div class="search-db"><gcse:searchbox></gcse:searchbox></div>
          <div id="etp">
            <ul>
              <li><a href="https://github.com/mongodb/docs/blob/master/source/use-cases/pre-aggregated-reports.txt" target="_blank" title="Edit use-cases/pre-aggregated-reports.txt on GitHub">Edit this Page</a></li>
              <li><a href="http://github.com/mongodb/docs" target="_blank" title="Fork the documentation on GitHub and contribute.">GitHub</a></li>
              <li><a id="jirafeedback" href="https://jira.mongodb.org/secure/CreateIssueDetails!init.jspa?pid=10380&issuetype=4&priority=4&summary=Comment+on%3a+%22use-cases/pre-aggregated-reports%2Etxt%22" target="_blank" title="Report a problem with use-cases/pre-aggregated-reports.txt on Jira">Report a Problem</a></li>
            </ul>
          </div>
      <div class="footer">
        <p>
          &copy; <a href="">Copyright</a> 2011-2013, 10gen, Inc. 
          MongoDB&reg;, Mongo&reg;, and the leaf logo are registered trademarks of <a href="http://www.10gen.com/">10gen, Inc.</a>
        </p>
      </div><script type="text/javascript">
var _gaq = _gaq || [];
var pluginUrl = (('https:' == document.location.protocol) ? 'https://ssl.' : 'http://www.') + 'google-analytics.com/plugins/ga/inpage_linkid.js';
_gaq.push(['_require', 'inpage_linkid', pluginUrl]);
_gaq.push(['_setAccount', 'UA-7301842-8']);
_gaq.push(['_setDomainName', 'docs.mongodb.org']);
_gaq.push(['_trackPageview']);
(function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
        })();
</script>

<script type="text/javascript">var _kiq = _kiq || [];</script>
<script type="text/javascript">
(function(){
setTimeout(function(){ var d = document, f = d.getElementsByTagName('script')[0], s = d.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//s3.amazonaws.com/ki.js/49119/a7n.js'; f.parentNode.insertBefore(s, f); }, 1);
})();
</script>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-7301842-14', 'mongodb.org');
ga('send', 'pageview');
</script>

<script type="text/javascript">
document.write(unescape("%3Cscript src='" + document.location.protocol + "//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script>try { mktoMunchkin("017-HGS-593"); } catch(e) {}</script><script type="text/javascript">
jQuery.ajax({
	 url: "https://jira.mongodb.org/s/en_UScn8g8x/782/6/1.2.5/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?collectorId=298ba4e7",
	 type: "get",
	 cache: true,
	 dataType: "script"
	});
window.ATL_JQ_PAGE_PROPS =  {
	"triggerFunction": function(showCollectorDialog) {
		jQuery("#jirafeedback").click(function(e) {e.preventDefault();showCollectorDialog();});},
		fieldValues: {component: 'mongodb-manual', summary: 'Comment on: "manual/use-cases/pre-aggregated-reports.txt"'},
		environment: {'repo': 'docs','source': 'use-cases/pre-aggregated-reports'}
		};
</script><script type="text/javascript">
var versions = [{'t': '2.4 (current)', 'v': 'v2.4'}, {'t': '2.2', 'v': 'v2.2'}]
var pagename = 'use-cases/pre-aggregated-reports'
var stable = 'v2.4'

function vfnav() {
    if ( pagename=='index' ) {
        pn = ''
    }
    else {
        pn = pagename
    }

    v = $(this).children("option:selected").attr('value')

    if ( (v==0) || (v==stable) ) {
        uri = '/manual/' + pn
    }
    else {
        uri = '/' + v + '/' + pn
    }
    window.location.href= uri;
}

$(document).ready(function(){
    $("#vn").html(function(){
        s=$("<select/>");
        o='<option/>';

        $.each(versions,function(index, version) {
            if ( version.v==stable ) {
                dv=true;
            }
            $(o,{value:version.v,text: version.t}).appendTo(s);
        });

        if ( dv==false ) {
            $(o, {value:0,text:'(stable)'}).appendTo(s);
        }
        return(s);
    });

    $("#vn select").bind('change', vfnav);
    $('#vn select').val('v2.4');
});
</script>
</body>
</html>